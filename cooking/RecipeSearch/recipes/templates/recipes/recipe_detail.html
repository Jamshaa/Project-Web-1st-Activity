{% extends 'recipes/base.html' %}

{% block title %}Recipe Detail{% endblock %}

{% block content %}
<div class="recipe-detail">
    <h2>{{ recipe.title }}</h2>
    {% if recipe.image %}
        <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
    {% endif %}
    <p><strong>Instructions:</strong></p>
    <div>{{ recipe.instructions|safe }}</div>
    <p><a href="{% url 'recipes:recipe_feedback' recipe.spoonacular_id %}">Leave Feedback</a></p>
    {% if user.is_authenticated %}
        <button id="save-recipe" data-recipe-id="{{ recipe.spoonacular_id }}">Save Recipe</button>
    {% else %}
        <p><a href="{% url 'recipes:login' %}">Log in</a> to save this recipe.</p>
    {% endif %}
</div>

<script>
document.getElementById('save-recipe')?.addEventListener('click', function() {
    const recipeId = this.getAttribute('data-recipe-id');
    fetch(`/recipe/${recipeId}/save/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
    })
    .catch(error => console.error('Error:', error));
});
</script>
{% endblock %}

<h3>Leave Feedback</h3>
{% if user.is_authenticated %}
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Submit Feedback</button>
  </form>
{% else %}
  <p><a href="{% url 'recipes:login' %}">Log in</a> to leave feedback.</p>
{% endif %}

<h3>Feedback</h3>
{% for fb in feedbacks %}
  <p><strong>{{ fb.user.username }}</strong>: {{ fb.comment }} <em>on {{ fb.created_at }}</em></p>
{% empty %}
  <p>No feedback yet.</p>
{% endfor %}
